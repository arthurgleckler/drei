<!DOCTYPE html>
<html>
<head>
  <title>expandRange Tests</title>
  <style>
    body { font-family: sans-serif; }
    #fixtures { display: none; }
    #results div { margin-bottom: 8px; }
    .fail { color: red; }
    .pass { color: green; }
    .summary { margin-top: 1em; border-top: 1px solid #ccc; padding-top: 1em; }
  </style>
</head>
<body>
  <h1>expandRange Tests</h1>
  <div id="results"></div>
  <div id="fixtures"><p id="p1">First paragraph.</p><p id="p2">Second <span id="s">paragraph</span> here.</p></div>

  <script src="../src/emacs.js"></script>

  <script>
    function assertDeepEqual(actual, expected) {
      const actualJson = JSON.stringify(actual);
      const expectedJson = JSON.stringify(expected);

      if (actualJson !== expectedJson) {
        throw new Error(
          `Expected: ${expectedJson}<br/>&nbsp;&nbsp;` +
          `Actual: ${actualJson}`
        );
      }
    }

    function assertCollectEqual(actual, expected) {
      if (actual.length !== expected.length) {
        throw new Error(
          `Expected length: ${expected.length}<br/>&nbsp;&nbsp;` +
          `Actual length: ${actual.length}`
        );
      }
      for (let i = 0; i < actual.length; i++) {
        if (actual[i] !== expected[i]) {
          const actualValue = typeof actual[i] === 'string'
            ? `"${actual[i]}"`
            : actual[i].nodeName;
          const expectedValue = typeof expected[i] === 'string'
            ? `"${expected[i]}"`
            : expected[i].nodeName;

          throw new Error(
            `Expected at index ${i}: ${expectedValue}` +
            `<br/>&nbsp;&nbsp;Actual at index ${i}: ${actualValue}`
          );
        }
      }
    }

    function runTests() {
      const p1 = document.getElementById("p1");
      const p2 = document.getElementById("p2");
      const s = document.getElementById("s");
      const r = document.createRange();

      r.setStart(p1.firstChild, 6); // Start at "paragraph" in p1.
      r.setEnd(p2.lastChild, 1);    // End before "here" in p2.

      const tests = [
        ["expandRange with partial range",
         () => assertDeepEqual(
           expandRange(r),
           ["paragraph.", "Second ", "paragraph", " "])],
        ["collect with partial range",
         () => assertCollectEqual(
           collect(r),
           ["paragraph.", p1, "Second ", p2, "paragraph", s, " ", p2])]
      ];

      const results = document.getElementById("results");
      let passCount = 0;

      for (const [name, thunk] of tests) {
        try {
          thunk();
          passCount++;
          results.innerHTML += `<div class="pass">PASS: ${name}</div>`;
        } catch (e) {
          results.innerHTML +=
            `<div class="fail">FAIL: ${name}<br/>&nbsp;&nbsp;` +
            `${e.message}</div>`;
        }
      }
      results.innerHTML +=
        `<div class="summary">${passCount}/${tests.length} ` +
        `tests passed.</div>`;
    }

    runTests();
  </script>
</body>
</html>
